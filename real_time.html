<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Object Detection</title>
    <script type="text/javascript"
        src="https://me.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=1inefG58ViLXQQ0mnPMWnN5Is0xn3rmKroDAnHviXs2MivmcNvIfet9HhyBqOn8ThMoPLf3OaGjV9jEzVQhBUKjQFDGNU3_J3pDN9t7rsxtQzgnG0rconBBCOyNjYEPlWOmXs_Fj4GkAtrUM-s48Yc_UyKnD9gRHZSJhVsfre56OVgU2VNAyETq2Sso9gMsv8tGVMIfj9VUtw1MeXzbskVL_geputbba_3YI_CcKis_jQzgZwl1pTklx_Bok1jPBgmYthfGCSOJa3ZXW54UEpgfVfDikvq7yyFlm0Nl6kXj3akfjU8Z0oVFv28K-hGHNZaPFLq8pAFD0x_DjVb4o2-czRXw2RBIcaZmWEF7ZNydP6fHliQCUlvJvDzUSzNh5XL1UudLHCXfY3zzEnIda0v5iXBAW8yOmQBNlc5SJ6YKQKy8B8lbokOcVaT6QOD7EMhBuHOsEBXSCqub_3qgaqVVB237ZugQSPtjUyaDH1YhgLdR3vCOBHJgXyykJ9CK4IRPKoVwvbQCNM25-SfmI0S7ZwD1vg5vzQ9Fsf21_IZm6VHFv-L19Yl96HDPcKOc_gvupewa-ZF0JYT0f2mUL_u5W_jEGj_cOQ6aK2t2A5faGDS4ii35v_8o6YC1im1vi_Yq8Z8EelGzut8wnxvmOqhBNsAnnuVVY12d1xBOWZLffHpvs6FLPc3C0m3-uVmEG8QIFg1gGG5t5bUfJTIp-7-VtS1PI4NOHQSnt84QSdb4j98AmNwNQwg3igSM9VEkO6Be1M80uaD6chdgAdblI-Hd8FhjMFtSHCpoaFXBLn4UKiFofTSAWgpheRkqgpdhkvx74BXvGZEyds8gO7ZPChzIT9zI_x-iBQSRIrt07cTLdJ2oHuD27r2a3VLsH60zh2VijE1r_KYeYgfNFZ45z7scbNwh-VUerQQWVlUbDHCvAxZbZQzaOZsBP7zdgcGGfywNcU75_I0wNB46MMT2x7hEWRczZXjW6pH7AOgU24U2-LkndTXzdNFb5c8rCf2-nX4929WcC8UGpK83AHnLhomPWRQ2_Afj72X3miLCS-p6FSRVrHHzpYZrvIgu2eJN9D1EwrQw9TTJqD84AQSKxLILg8kAeruAvwr3-tA8nf3Yjn2_c5Bhe-L5dowslhAbVIEfG6pjxtY2B1QOK7hMZgHI_5yiulSZzHXqvfjFDXRY0r7rLCttS2Aodu5E6Lz3nIsJCNttV1w2wbhCRiUH02odu00LKp4VMNBNyG4RGhfqpfqxAldniIo-82GdRrDAB-GWWAsn07gnR3iuIn15lQY-JYdjtL86NW9AntH6_lNiqxUuDJPgljGRfTCmOrOkj1B15Tchiipyo66tQeO7NbD9kqGjFc4gbzSfLQrMFSQqfdHnekdHl1gsebW742n8UwVNS6iR_cQ69A--wN1bOGTuUHfcVDAcrqeMVjG_BaTrjoNn0DtPoqUu4xrvNfnwOtOKRuREnXK3Um7IAdy13JgLTtGBQLXEkunsa49VG93CffUidOfjxgSUqE5ZpoI4g0Trac3QjVHaIhK3KCf7Q46w0QgJEYheUh1Nuslqzc7ROokpU2ygNiwsWEYac4DIeEDHEF5WTq3JlHnAP7xWu76te8YRlkI09qoXSxSu0MbOBSsAL7RbNxvf4mU7zYxbmJp704miFml6QJ3Xmw3sPke39_4YduUeWnfVsXQDVKiKfD22QzVkJvVouhVG7iV0JiqqYJOU8fOnurBBn69X-kKEejXljZBheU6xqaSp0Tsc"
        nonce="47ac606620fc768cff2fee4c49998409" charset="UTF-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
        integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
        crossorigin="anonymous"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
        }

        #videoContainer {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        #originalVideo,
        #annotatedCanvas {
            border: 1px solid #ccc;
        }

        #graphContainer {
            width: 80%;
            margin: 0 auto;
        }

        button,
        input {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <h1>Video Object Detection with YOLO and ByteTrack</h1>
    <input type="file" id="videoInput" accept="video/*" onchange="uploadVideo()" />
    <button onclick="playVideo()">Process Video</button>
    <div id="videoContainer">
        <video id="originalVideo" controls width="512" height="512"></video>
        <canvas id="annotatedCanvas" width="512" height="512"></canvas>
    </div>
    <div id="graphContainer">
        <canvas id="detectionGraph"></canvas>
    </div>
    <script>
        let FPS = 125;

        let frameIndex = 0;
        const videoInput = document.getElementById("videoInput");
        const originalVideo = document.getElementById("originalVideo");
        const annotatedCanvas = document.getElementById("annotatedCanvas");
        const ctx = annotatedCanvas.getContext("2d");

        const socket = io();
        const detectionCounts = [];
        let chart;

        socket.on("connect", () => {
            console.log("Socket.IO connected");
        });

        socket.on("response", (data) => {
            const parsedData = JSON.parse(data);

            if (parsedData.image) {

                const img = new Image();
                img.onload = () => {
                    annotatedCanvas.width = img.width;
                    annotatedCanvas.height = img.height;
                    ctx.clearRect(0, 0, img.width, img.height);
                    ctx.drawImage(img, 0, 0);
                };
                img.src = parsedData.image;

                img.onload = () => {
                    ctx.clearRect(0, 0, 512, 512);
                    ctx.drawImage(img, 0, 0, 512, 512);
                };

                detectionCounts.push(parsedData.count);
                updateGraph(detectionCounts);
            }
        });

        socket.on("disconnect", () => {
            console.log("Socket.IO disconnected");
        });

        socket.on("connect_error", (err) => {
            console.error("Socket.IO connection error:", err);
        });



        function uploadVideo() {
            const file = videoInput.files[0];
            if (!file) {
                alert("Please select a video file.");
                return;
            }

            const formData = new FormData();
            formData.append("video", file);

            fetch("/upload", {
                method: "POST",
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    originalVideo.src = URL.createObjectURL(file);
                    // startProcessing();
                })
                .catch((error) => {
                    console.error("Error uploading video:", error);
                    alert("Failed to upload video.");
                });
        }

        function playVideo() {
            function captureOneFrame() {
                const video = originalVideo;
                const offscreenCanvas = document.createElement("canvas");
                offscreenCanvas.width = video.videoWidth;
                offscreenCanvas.height = video.videoHeight;

                const ctx = offscreenCanvas.getContext("2d");
                if (!ctx) return;

                ctx.drawImage(
                    video,
                    0,
                    0,
                    offscreenCanvas.width,
                    offscreenCanvas.height
                );
                const imageData = offscreenCanvas.toDataURL("image/jpeg");

                if (socket.connected) {
                    socket.emit("frame", imageData);
                }
            }

            function startFrameCapture(interval = FPS) {
                const captureInterval = setInterval(() => {
                    if (!originalVideo.paused && !originalVideo.ended) {
                        captureOneFrame();
                    } else {
                        clearInterval(captureInterval);
                    }
                }, interval);
            }

            originalVideo.onplay = () => {
                startFrameCapture();
            };
            originalVideo.play();
        }
        function updateGraph(counts) {
            if (!chart) {
                chart = new Chart(document.getElementById("detectionGraph"), {
                    type: "line",
                    data: {
                        labels: counts.map((_, i) => i),
                        datasets: [
                            {
                                label: "Number of Detected Objects",
                                data: counts,
                                borderColor: "blue",
                                fill: false,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { title: { display: true, text: "Frame Number" } },
                            y: {
                                title: { display: true, text: "Object Count" },
                                beginAtZero: true,
                            },
                        },
                    },
                });
            } else {
                chart.data.labels = counts.map((_, i) => i);
                chart.data.datasets[0].data = counts;
                chart.update();
            }
        }
    </script>
</body>

</html>